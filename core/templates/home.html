<!DOCTYPE html>
<html>
<head>
  <title>Maps Test</title>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />

  <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/home.css">
  <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/bootstrap.css">
  
  <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyClqmnPFZDxh_XIktPvuNQuo8F7mQ86ORc&sensor=FALSE"></script>
  <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=places"></script>
  <script src="//code.jquery.com/jquery-1.10.2.js"></script>
  <script src="{{ STATIC_URL }}js/bootstrap.min.js"></script>
  
  {% if user.is_authenticated %}
    <script type="text/javascript" src="{{ STATIC_URL }}js/drawing_maps.js"></script>
  {% endif %}
  <script type="text/javascript" src="{{ STATIC_URL }}js/creating_polygons.js"></script>
  <script type="text/javascript" src="{{ STATIC_URL }}js/search_box.js"></script>
  <script type="text/javascript" src="{{ STATIC_URL }}js/map.js"></script>

  <script type="text/javascript">
    function generate_polygons(){
      // GENERATING THE STORED POLYGONS
      {% for polygon in polygons %}
        var polygon_id = "{{ polygon.id }}";
        var polygon_points = "{{ polygon.points }}".split(", ");
        var polygon_color = "{{ polygon.color }}";
        var polygon_info_text = "{{ polygon.info_text }}{% if user.is_authenticated %}</br><a href='/edit_map/{{ polygon.id }}'>Edit</a></br><a href='/delete_map/{{ polygon.id }}'>Delete</a>{% endif %}";
        var polygon_path = [];

        for(i=0; i<polygon_points.length-1; i=i+2){
          var coordenate1 = polygon_points[i].substring(1);
          var coordenate2 = polygon_points[i+1].substring(0, polygon_points[i+1].length-1);
          var latlng = new google.maps.LatLng(coordenate1, coordenate2);
          polygon_path.push(latlng);
        }

        // EDITING MAPS
        {% if edit and user.is_authenticated %}
          if("{{ edit }}" == polygon_id){
            polygon = new_polygon(map, polygon_path, polygon_color, polygon_info_text, true, true);
          }else{
            var not_edit_polygon = new_polygon(map, polygon_path, polygon_color, polygon_info_text, false, false);
          }
        {% else %}
          polygon = new_polygon(map, polygon_path, polygon_color, polygon_info_text, false, false);
        {% endif %}
      {% endfor %}
    }
  </script>

  <script type="text/javascript">
    var map;
    var polygon = null;

    function initialize() {
      {% if not edit and user.is_authenticated %}
        document.getElementById("end_drawing").disabled = true;
      {% endif %}

      geocoder = new google.maps.Geocoder();
      var input = document.getElementById('searchTextField');
      var autocomplete = new google.maps.places.Autocomplete(input);
      
      map = init_map(map);
      generate_polygons();
    }
    google.maps.event.addDomListener(window, 'load', initialize);
  </script>
</head>

<body>
  <form method="POST", action="/save_map/{% if edit %}{{ edit }}/{% endif %}" name="new_map_form">
    {% csrf_token %}
    <input type="hidden" name="points">
    <input type="hidden" name="color" id="id_color">
    <input type="hidden" name="info_text">
  </form>

  <div class="my_header">
    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="navbar-header hidden-sm">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="/">Phosphorus Media</a>
      </div>

      <div class="navbar-collapse collapse">
        <ul class="nav navbar-nav navbar-right" style="padding-right:15px;">
          
          <!-- Search Box -->
          <li>
            <div class="navbar-form navbar-input-group my_search" role="search">
              <div class="form-group" style="margin-left: 15px;">
                <input id="searchTextField" type="textbox" class="form-control" placeholder="Enter location">
                <button onclick="codeAddress()" class="btn btn-primary">Search</button>
              </div>
            </div>
          </li>
          
          <!-- Filters Box -->
          <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Filters<b class="caret"></b></a>
            <ul class="dropdown-menu">
              <li>
                {% for color, value in colors %}
                  <a href="/filter/{{ value }}/"><div style="background-color: {{ color }};" class="filter_color_box"></div></a>
                {% endfor %}
                <a href="/"><div class="filter_color_box">All</div></a>
              </li>
            </ul>
          </li>

          {% if not user.is_authenticated %}
            <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Login<b class="caret"></b></a>
                <ul class="dropdown-menu" style="padding:15px;">
                  <li>
                    <form method="post" action="/login/" role="form">
                      {% csrf_token %}
                      <div class="form-group">
                        <input type="text" placeholder="Username" name="username" class="form-control">
                      </div>
                      <div class="form-group">
                        <input type="password" placeholder="Password" name="password" class="form-control">
                      </div>
                      <button type="submit" class="btn btn-default">Sign in</button>
                    </form>
                  </li>
                </ul>
            </li>
          {% else %}
            <li><a href="/logout/">Logout</a></li>
          {% endif %}
        </ul>
      </div>
    </div>
  </div>

  {% if user.is_authenticated %}
    {% include 'polygon_form.html' %}
  {% endif %}

  <div id="map-canvas" class="{% if user.is_authenticated %}authenticated{% endif %}"/>  
</body>
</html>